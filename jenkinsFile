pipeline{
    agent any
    environment {
        VERSION = "${env.BUILD_ID}"
        nexus_ip = "34.125.116.255"
    }
    
    stages{
        stage('Build'){
              tools {
                  maven '3.6.3'
              }        
            steps{
                sh 'mvn clean package'
            }
        }
        stage('sonar quality check'){
              tools {
                  maven '3.6.3'
              }                
            steps{
                script{
                    withSonarQubeEnv('sonar_server') {
                         sh "mvn sonar:sonar"
                    }
                    timeout(5) {
                        def qg = waitForQualityGate()
                        print "Finished waiting"
                        if(qg.status!='OK')
                        {
                            error "Pipeline aborted due to quality gate failure: ${qg.status}"
                        }
                    }
                }
            }
        }
        stage('docker image build and push')
        {
            steps{
                script{
                    //withCredentials([usernameColonPassword(credentialsId: 'nexus_pass', variable: 'nexus_password')]) {
                    withCredentials([string(credentialsId: 'nexus_pass', variable: 'nexus_password')]) {
                        sh '''                     
                        docker login -u admin -p ${nexus_password} http://${nexus_ip}:8083/
                        docker build -t ${nexus_ip}:8083/${JOB_NAME}:${VERSION} .                                      
                        docker push ${nexus_ip}:8083/${JOB_NAME}:${VERSION}
                        docker rmi ${nexus_ip}:8083/${JOB_NAME}:${VERSION}
                        '''
                    }
                }
                    
                }
            }
        }
            
    }
